// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// 통합 마스터 데이터
// ============================================

// 통합 품목 마스터 (모든 모듈에서 사용)
model Product {
  id                    Int       @id @default(autoincrement())
  code                  String?   @unique  // 선택적 품목코드
  name                  String
  unit                  String    @default("EA")  // 개, BOX, kg 등
  categoryId            Int?
  category              Category? @relation(fields: [categoryId], references: [id])
  description           String?
  
  // 매입 거래처 (필수, 1:1)
  purchaseVendorId      Int
  purchaseVendor        Vendor    @relation("PurchaseVendor", fields: [purchaseVendorId], references: [id])
  
  // 매출 거래처 (다대다 관계)
  salesVendors          ProductSalesVendor[]
  
  // 기본 단가 (거래처별 특별가가 없을 때 사용)
  defaultPurchasePrice  Float?    // 기본 매입가
  defaultSalesPrice     Float?    // 기본 매출가
  
  // 관계
  priceHistory          ProductPriceHistory[]
  vendorPrices          VendorProductPrice[]   // 거래처별 특별가
  salesRecords          SalesRecord[]          // 매입매출
  importExports         ImportExport[]         // 수입/수출
  importExportItems     ImportExportItem[]     // 수입/수출 품목 상세
  inventoryLots         InventoryLot[]         // 창고 입고
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// 품목-매출거래처 다대다 관계 테이블
model ProductSalesVendor {
  id          Int      @id @default(autoincrement())
  productId   Int
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  vendorId    Int
  vendor      Vendor   @relation("SalesVendor", fields: [vendorId], references: [id])
  addedAt     DateTime @default(now())
  
  @@unique([productId, vendorId])
}

// 품목 가격 이력
model ProductPriceHistory {
  id             Int       @id @default(autoincrement())
  productId      Int
  product        Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  effectiveDate  DateTime  // 적용 시작일
  purchasePrice  Float?    // 매입 단가
  salesPrice     Float?    // 매출 단가
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  @@index([productId, effectiveDate])
}

// 통합 거래처 마스터
model Vendor {
  id              Int                   @id @default(autoincrement())
  code            String                @unique
  name            String
  type            String                @default("DOMESTIC_PURCHASE") // DOMESTIC_PURCHASE, DOMESTIC_SALES, INTERNATIONAL_PURCHASE, INTERNATIONAL_SALES
  contactPerson   String?
  phone           String?
  email           String?
  address         String?
  country         String?               // 해외 거래처용
  currency        String?               // 기본 통화 (USD, EUR, JPY 등)
  memo            String?
  
  // 관계
  purchaseProducts    Product[]  @relation("PurchaseVendor")  // 이 거래처가 매입처인 품목들
  salesProducts       ProductSalesVendor[]  @relation("SalesVendor")  // 이 거래처가 매출처인 품목들
  vendorPrices    VendorProductPrice[]
  salesRecords    SalesRecord[]
  importExports   ImportExport[]
  inventoryLots   InventoryLot[]
  
  // 재료/부품 매입처
  materials           Material[]  @relation("MaterialPurchaseVendor")
  parts               Part[]      @relation("PartPurchaseVendor")
  
  // 재료/부품 매출처
  materialsSales      Material[]  @relation("MaterialSalesVendor")
  partsSales          Part[]      @relation("PartSalesVendor")
  
  // 서비스 매출처
  services            Service[]   @relation("ServiceSalesVendor")
  
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
}

// 거래처별 품목 특별가격
model VendorProductPrice {
  id              Int       @id @default(autoincrement())
  vendorId        Int
  vendor          Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  productId       Int
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  purchasePrice   Float?    // 해당 거래처 매입가
  salesPrice      Float?    // 해당 거래처 매출가
  effectiveDate   DateTime  // 적용 시작일
  memo            String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([vendorId, productId, effectiveDate])
}

// 통합 담당자 마스터
model Salesperson {
  id              Int            @id @default(autoincrement())
  code            String?        @unique  // BS, IK, YR, SJ (optional)
  name            String
  commissionRate  Float          @default(0)  // IK는 0.15
  
  // 관계
  salesRecords    SalesRecord[]
  importExports   ImportExport[]
  inventoryLots   InventoryLot[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

// 통합 카테고리 마스터
model Category {
  id              Int            @id @default(autoincrement())
  code            String?        @unique  // Optional
  name            String         // Machine, Parts, Fount 등
  nameKo          String         // 기계, 부품, 약물및습수액 등
  
  // 관계
  products        Product[]
  salesRecords    SalesRecord[]
  importExports   ImportExport[]
  materials       Material[]
  parts           Part[]
  services        Service[]   @relation("ServiceCategory")
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

// ============================================
// 수입/수출 관리
// ============================================

// 수입/수출 기록
model ImportExport {
  id              Int          @id @default(autoincrement())
  date            DateTime
  type            String       // IMPORT(수입) or EXPORT(수출)
  
  // 마스터 연결 (통합)
  productId       Int?         // 단일 품목용 (하위 호환성)
  product         Product?     @relation(fields: [productId], references: [id])
  vendorId        Int
  vendor          Vendor       @relation(fields: [vendorId], references: [id])
  salespersonId   Int?
  salesperson     Salesperson? @relation(fields: [salespersonId], references: [id])
  categoryId      Int?
  category        Category?    @relation(fields: [categoryId], references: [id])
  
  // 다중 품목 지원
  items           ImportExportItem[]
  
  // 통관 정보 (역참조)
  customsClearances CustomsClearance[]
  
  // 수량 및 금액 (단일 품목용, 하위 호환성)
  quantity        Float?
  
  // 외화 정보
  currency        String       // USD, EUR, JPY 등
  exchangeRate    Float        // 환율 (직접 입력)
  foreignAmount   Float        // 외화 금액 (총액)
  krwAmount       Float        // 원화 환산 금액
  
  // 수입 원가 구성 (수입 시)
  goodsAmount     Float?       // 물품대금 (외화)
  dutyAmount      Float?       // 관세 (원화)
  shippingCost    Float?       // 운송료 (원화)
  otherCost       Float?       // 기타 비용 (원화)
  totalCost       Float?       // 총 원가 (원화)
  unitCost        Float?       // 단위 원가
  
  // 보관 옵션
  storageType     String?      // WAREHOUSE(창고입고), OFFICE(사무실보관), DIRECT_DELIVERY(직배), OTHER(기타)
  inventoryLot    InventoryLot? // 자동 입고 시 생성된 LOT 참조
  
  // 부가세
  vatIncluded     Boolean      @default(false)
  supplyAmount    Float?       // 공급가액
  vatAmount       Float?       // 부가세액
  totalAmount     Float?       // 합계 (공급가액 + 부가세)
  
  memo            String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

// 환율 관리
model ExchangeRate {
  id              Int          @id @default(autoincrement())
  date            DateTime
  currency        String       // USD, EUR, JPY, CNY 등
  rate            Float        // 환율 (원화 기준)
  source          String?      // 출처 (예: 하나은행, 직접입력)
  
  createdAt       DateTime     @default(now())
  
  @@unique([date, currency])
}

// 시스템 설정 (환율 자동 업데이트 등)
model SystemSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// 창고 관리
// ============================================

// 품목 마스터 (하위 호환성 유지, 향후 Product로 통합)
model Item {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  unit        String   // 개, BOX, kg 등
  note        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  lots        InventoryLot[]
  movements   InventoryMovement[]
}

// LOT/입고 관리
model InventoryLot {
  id                Int          @id @default(autoincrement())
  itemId            Int?
  item              Item?        @relation(fields: [itemId], references: [id])
  productId         Int?         // 통합 품목 연결
  product           Product?     @relation(fields: [productId], references: [id])
  vendorId          Int?         // 거래처 연결
  vendor            Vendor?      @relation(fields: [vendorId], references: [id])
  salespersonId     Int?         // 담당자 연결
  salesperson       Salesperson? @relation(fields: [salespersonId], references: [id])
  
  lotCode           String?      // BL번호, 참조번호 등
  receivedDate      DateTime
  quantityReceived  Float        // 입고 수량
  quantityRemaining Float        // 현재 잔량
  
  goodsAmount       Float        // 물품대금
  dutyAmount        Float        // 수입통관료
  domesticFreight   Float        // 국내 입고운송료
  otherCost         Float        @default(0) // 기타 비용
  unitCost          Float        // 단가 (자동계산)
  
  // 보관 위치
  storageLocation   String       @default("WAREHOUSE")  // 'WAREHOUSE' 또는 'OFFICE'
  
  // 수입/수출 참조 (자동 생성된 경우)
  importExportId    Int?         @unique
  importExport      ImportExport? @relation(fields: [importExportId], references: [id])
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  
  movements         InventoryMovement[]
}

// 입출고 이력
model InventoryMovement {
  id           Int      @id @default(autoincrement())
  movementDate DateTime
  itemId       Int
  item         Item     @relation(fields: [itemId], references: [id])
  lotId        Int?
  lot          InventoryLot? @relation(fields: [lotId], references: [id])
  type         String   // IN, OUT, ADJUST
  quantity     Float
  unitCost     Float
  totalCost    Float    // quantity * unitCost
  
  refType      String?  // 참조 타입
  refId        String?  // 참조 ID
  
  createdAt    DateTime @default(now())
}

// 창고료/기간비용
model StorageExpense {
  id          Int      @id @default(autoincrement())
  period      String   // '2026-02' 형태
  dateFrom    DateTime
  dateTo      DateTime
  warehouseId Int?     // 추후 확장용
  amount      Float
  memo        String?
  
  createdAt   DateTime @default(now())
}

// 매입매출 기록
model SalesRecord {
  id            Int          @id @default(autoincrement())
  date          DateTime
  type          String       // PURCHASE(매입) or SALES(매출)
  salespersonId Int
  salesperson   Salesperson  @relation(fields: [salespersonId], references: [id])
  categoryId    Int
  category      Category     @relation(fields: [categoryId], references: [id])
  productId     Int?         // 통합 품목 연결
  product       Product?     @relation(fields: [productId], references: [id])
  salesProductId Int?        // 기존 매입매출 품목 연결 (하위 호환성)
  salesProduct  SalesProduct? @relation(fields: [salesProductId], references: [id])
  vendorId      Int?         // 거래처 연결
  vendor        Vendor?      @relation(fields: [vendorId], references: [id])
  itemName      String       // 품목명 (품목 미선택시 직접 입력)
  customer      String?      // 기존 필드 유지 (하위 호환성)
  quantity      Float
  unitPrice     Float
  amount        Float        // 수량 * 단가
  cost          Float        @default(0) // 원가 (매출 시)
  margin        Float        @default(0) // 마진 = amount - cost
  marginRate    Float        @default(0) // 마진율
  
  // 부가세
  vatIncluded   Boolean      @default(false)  // 부가세 포함 여부
  supplyAmount  Float?       // 공급가액
  vatAmount     Float?       // 부가세액
  totalAmount   Float?       // 합계 (공급가액 + 부가세)
  
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

// ============================================
// 하위 호환성 유지 (향후 마이그레이션)
// ============================================

// 품목 카테고리 (향후 Category로 통합)
model ProductCategory {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String   // Machine, Parts, Fount 등
  nameKo    String   // 기계, 부품, 약물및습수액 등
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 매입매출용 품목 마스터 (향후 Product로 통합)
model SalesProduct {
  id          Int                  @id @default(autoincrement())
  name        String               @unique
  description String?
  unit        String               @default("EA") // 단위: EA, BOX, KG 등
  notes       String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  prices      SalesProductPrice[]
  sales       SalesRecord[]        // 매입매출 기록 연결
}

// 품목별 단가 이력 (향후 ProductPriceHistory로 통합)
model SalesProductPrice {
  id             Int          @id @default(autoincrement())
  productId      Int
  product        SalesProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  effectiveDate  DateTime     // 적용 시작일
  purchasePrice  Float        @default(0) // 매입 단가
  salesPrice     Float        @default(0) // 매출 단가
  notes          String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([productId, effectiveDate])
}

// ============================================
// 수입/수출 다중 품목
// ============================================

// 수입/수출 품목 상세 (다중 품목 지원)
model ImportExportItem {
  id              Int          @id @default(autoincrement())
  importExportId  Int
  importExport    ImportExport @relation(fields: [importExportId], references: [id], onDelete: Cascade)
  productId       Int
  product         Product      @relation(fields: [productId], references: [id])
  
  quantity        Float
  unitPrice       Float        // 단가 (외화)
  amount          Float        // 금액 (외화) = quantity * unitPrice
  krwAmount       Float        // 원화 환산 금액
  
  memo            String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([importExportId])
}

// ============================================
// 품목 테이블 분리 (재료, 부품, 서비스)
// ============================================

// 재료 (Material)
model Material {
  id                    Int       @id @default(autoincrement())
  code                  String?   @unique
  name                  String
  unit                  String    @default("EA")
  categoryId            Int?
  category              Category? @relation(fields: [categoryId], references: [id])
  description           String?
  
  purchaseVendorId      Int
  purchaseVendor        Vendor    @relation("MaterialPurchaseVendor", fields: [purchaseVendorId], references: [id])
  
  salesVendorId         Int?
  salesVendor           Vendor?   @relation("MaterialSalesVendor", fields: [salesVendorId], references: [id])
  
  defaultPurchasePrice  Float?
  
  projectItems          ProjectItem[]
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// 부품 (Part)
model Part {
  id                    Int       @id @default(autoincrement())
  code                  String?   @unique
  name                  String
  unit                  String    @default("EA")
  categoryId            Int?
  category              Category? @relation(fields: [categoryId], references: [id])
  description           String?
  
  purchaseVendorId      Int
  purchaseVendor        Vendor    @relation("PartPurchaseVendor", fields: [purchaseVendorId], references: [id])
  
  salesVendorId         Int?
  salesVendor           Vendor?   @relation("PartSalesVendor", fields: [salesVendorId], references: [id])
  
  defaultPurchasePrice  Float?
  
  projectItems          ProjectItem[]
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// 서비스 (Service) - 작업 기록용
model Service {
  id                Int       @id @default(autoincrement())
  code              String?   @unique
  name              String    // 서비스명
  description       String?
  
  // 서비스 시간 (optional)
  serviceHours      Float?    // 서비스 시간
  
  // 매출처
  salesVendorId     Int?
  salesVendor       Vendor?   @relation("ServiceSalesVendor", fields: [salesVendorId], references: [id])
  
  // 카테고리
  categoryId        Int?
  category          Category? @relation("ServiceCategory", fields: [categoryId], references: [id])
  
  projectItems      ProjectItem[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// ============================================
// 프로젝트 관리
// ============================================

// 프로젝트
model Project {
  id              Int          @id @default(autoincrement())
  code            String?      @unique
  name            String       // 프로젝트명
  customer        String?      // 고객사
  
  startDate       DateTime     // 시작일
  endDate         DateTime?    // 종료일
  status          String       @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, CANCELLED
  
  // 통화 정보
  currency        String       @default("KRW") // KRW, USD, EUR
  exchangeRate    Float        @default(1)
  
  // 원가 항목
  partsCost       Float        @default(0) // 부품 원가
  laborCost       Float        @default(0) // 인건비 원가
  customsCost     Float        @default(0) // 관세
  shippingCost    Float        @default(0) // 운송료
  otherCost       Float        @default(0) // 기타 비용
  totalCost       Float        @default(0) // 총 원가
  
  // 판매 및 마진
  salesPrice      Float        @default(0) // 판매가
  margin          Float        @default(0) // 마진 = 판매가 - 총 원가
  marginRate      Float        @default(0) // 마진율 = 마진 / 판매가 × 100
  
  memo            String?
  
  items           ProjectItem[]
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

// 프로젝트 품목 상세
model ProjectItem {
  id          Int       @id @default(autoincrement())
  projectId   Int
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  itemType    String    // MATERIAL, PART, SERVICE
  
  // 품목 참조 (하나만 사용)
  materialId  Int?
  material    Material? @relation(fields: [materialId], references: [id])
  partId      Int?
  part        Part?     @relation(fields: [partId], references: [id])
  serviceId   Int?
  service     Service?  @relation(fields: [serviceId], references: [id])
  
  itemName    String    // 품목명 (직접 입력 또는 품목에서 가져옴)
  
  // 수량 및 단가
  quantity    Float
  unitPrice   Float     // 단가
  amount      Float     // 금액 = quantity * unitPrice
  
  // 서비스 전용 필드
  workDate    DateTime? // 작업일
  workHours   Float?    // 작업시간
  engineer    String?   // 담당 엔지니어
  
  memo        String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([projectId])
}

// ============================================
// 통관 관리 (UNI-PASS 연동)
// ============================================

// 통관 진행 상황
model CustomsClearance {
  id              String   @id @default(cuid())
  blNumber        String   // BL번호 (House B/L 또는 Master B/L)
  blYear          String   // BL년도
  cargoNumber     String?  // 화물관리번호
  status          String   // 통관상태 (입항, 검사중, 심사중, 통관완료 등)
  declareNumber   String?  // 수입신고번호
  
  // 화물 정보
  productName     String?  // 품명
  quantity        Float?   // 수량
  weight          Float?   // 중량(kg)
  
  // 일자 정보
  arrivalDate     DateTime? // 입항일
  declareDate     DateTime? // 신고일
  clearanceDate   DateTime? // 통관완료일
  
  // 비용 정보
  customsDuty     Float?   // 관세
  vat             Float?   // 부가세
  totalTax        Float?   // 총 세금
  shippingCost    Float?   // 운송비
  
  // 연동 정보
  importId        Int?     // 수입내역 연동 ID
  import          ImportExport?  @relation(fields: [importId], references: [id])
  syncedAt        DateTime? // 마지막 동기화 시간
  rawData         String?  // 원본 API 응답 데이터 (JSON 문자열)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([blNumber, blYear])
}
